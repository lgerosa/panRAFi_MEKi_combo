---
title: "Import drug-dose response data for dose projections into gDR"
author: "Bartosz Czech, Luca Gerosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedExperiment)
library(MultiAssayExperiment)
```

# 1) Generate drug plate maps directly from the HP D300 dispensing files

```{r drug_dose_layout}
D300 <- './rawdata/D300_10052022_384w_belva_cobi_synergy.tdd' 
metadata <- './rawdata/D300_Gnumbers_10052022_384w_belva_cobi_synergy.xlsx'
gDRimport::import_D300(D300, metadata , './rawdata')
```

# 2) Import raw data into gDR

```{r load_data}
#import data
manifest <- './rawdata/manifest_10052022_384w_belva_cobi_synergy.xlsx'
treatment <- list.files('./rawdata/', 'trt_', full.names = TRUE)
raw_data <- './rawdata/raw_data_10052022_384w_belva_cobi_synergy.xlsx'    

data_imported <- gDR::import_data(manifest, treatment, raw_data, instrument = "Tecan")

#remove statutosporin data
idx <- data_imported$DrugName != "Staurosporine" 
data_imported <- data_imported[idx,]

#change the doubling rate for IPC-298 to the measured by Fran with incucyte
idx <- data_imported$CellLineName == "IPC-298"
data_imported[idx, c('ReferenceDivisionTime')] <- 60
#change the doubling rate of A375 to the one measured by Fran with incucyte
idx <- data_imported$CellLineName == "A375"
data_imported[idx, c('ReferenceDivisionTime')] <- 45

#change names for drugs
idx <- data_imported$Gnumber=='G03083045' 
data_imported[idx, c('DrugName')] <- 'panRAFi_Belvarafenib'
idx <- data_imported$Gnumber=='G00050939' 
data_imported[idx, c('DrugName')] <- 'MEKi_Cobimetinib'
idx <- data_imported$Gnumber_2=='G00050939' 
data_imported[idx, c('DrugName_2')] <- 'MEKi_Cobimetinib'

```
## 3) Split Data Based on Type (e.g. single-agent or combination)

```{r, split_types}
df_ <- gDRcore::identify_data_type(data_imported)
df_list <- gDRcore::split_raw_data(df_)
```

## 4) Extract single-agent and combination Data

```{r, extract_data}
sa_name <- gDRutils::get_experiment_groups("single-agent")[["single-agent"]]
combo_name <- gDRutils::get_experiment_groups("combination")
df_sa <- df_list[[sa_name]]
df_combo <- df_list[[combo_name]]
```

## 5) Create SummarizedExperiment Object.
Additionaly this step matches treatments with controls.
**Created assays:** RawTreated, Controls

```{r, create_SE}
se <- gDRcore::create_SE(df_sa, data_type = sa_name)
se_combo <- gDRcore::create_SE(df_combo, data_type = combo_name)
```

## 6) Normalize the Data
**Created assay:** Normalized

```{r normalize_data, warning=FALSE}
se <- gDRcore::normalize_SE(se, data_type = sa_name)
se_combo <- gDRcore::normalize_SE(se_combo, data_type = combo_name)
```

## 7) Average the Data
**Created assay:** Averaged

```{r, average_data}
se <- gDRcore::average_SE(se, data_type = sa_name)
se_combo <- gDRcore::average_SE(se_combo, data_type = combo_name)
```

## 8) Fit Metrics to the Data
**Created assay for single-agent data:** Metrics
**Created assays for combination data:** Metrics, excess, all_iso_points, isobolograms, score

```{r fit_data, warning=FALSE}
se <- gDRcore::fit_SE(se, data_type = sa_name)
se_combo <- gDRcore::fit_SE.combinations(se_combo, data_type = combo_name)
```

## 9) Create and save MAE Object

```{r create_mae}
mae <- MultiAssayExperiment::MultiAssayExperiment(experiments = setNames(list(se, se_combo), c(sa_name, combo_name)))
mae <- gDRutils::standardize_mae(mae)
saveRDS(mae, './Zoomed_in_Belva_Cobi_mae.RDS')
```

This completes the process of processing drug-dose response data using the gDRcore package.

```{r, plot_packages}
pkg_list <- as.data.frame(installed.packages(), stringsAsFactors = FALSE)
gDR_packages <- pkg_list[grepl("gDR", pkg_list$Package),]
print(paste(gDR_packages$Package, gDR_packages$Version, sep = ": "))
```
